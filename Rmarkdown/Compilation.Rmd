---
output: 
  html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_float: true
runtime: shiny
resource_files:
- UserDAs.cpg
- UserDAs.dbf
- UserDAs.prj
- UserDAs.sbn
- UserDAs.sbx
- UserDAs.shp
- UserDAs.shp.xml
- UserDAs.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


# Lower Colorado River Basin
This page is designed to provide current and historic system and water use stats. Data is pulled from.... 


##Current Reservoir Status  

```{r global_options, include=FALSE, resutls='asis'}
library(shiny)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(plotly)
library(leaflet)
library(rgdal)
library(rgeos)
library(sf)
library(raster)
library(rvest)
library(stringr)
library(lubridate)
library(gridExtra)

```




``` {r echo = FALSE, warning=FALSE, results='asis'}

  
library(shiny)
ui1 <- fluidPage(
  fluidRow(
    fluidRow(
      column(width=12,
        htmlOutput("DateOfData"), align="left", style='color:#cccccc;font-style: italic;'
      ),style="overflow-x:hidden;"
    ),
    column(width=12,
      plotOutput("bigdonut"), align="right", style='padding:0px;'
    ),style="overflow-x:hidden;"
  ), 
  fluidRow(
    column(width=12,
      plotOutput("donuts"), align ="center", style='padding:0px; height:300px; width:790px; object-fit: none; object-position: 200% 150%;'
    ), style="overflow-x:hidden; overflow-y:hidden;"
  )
)  


server1 <- shinyServer(function(input, output, session){
  
reservoir <- c("Lake Powell", "Lake Mead", "Lake Mohave", "Lake Havasu")
full <- c(30,50,90,95)
lab <- c("30%", "50%", "90%", "95%")
lakesize <- c(100, 1000, 100, 700)
ymin <- c(0,0,0,0)
xmin <- c(70, 70, 70, 70)
xmax <- c(100, 100, 100, 100)
dat <- tibble(reservoir, lab, full, lakesize, ymin, xmax)

output$bigdonut <- renderPlot({
  tot <- data.frame("reservoir"= "Total System", "full"=55, "lab"="55%", "lakesize"=10000,"ymin"=0,"xmin"=70, "xmax"=100)
  bd <- ggplot(tot) + 
    geom_rect(aes(ymax=100, ymin=0, xmax=100, xmin=70), colour=NA, fill="grey90") +
    geom_rect(aes(fill=full, ymax=full, ymin=ymin, xmax=xmax, xmin=xmin)) +
    scale_fill_gradient2(low="#FF8c00", midpoint=50, mid="#FFfa00", high="#00ff83", limits=c(0,100), guide=FALSE) +
    coord_polar(theta="y") +
    xlim(c(0,100)) + 
    ylim(c(0,100)) + 
    theme_minimal() +
    xlab("") + 
    ylab("Total System") +
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          axis.text=element_blank(),
          axis.title = element_text(size=13, colour="grey60", family="Calibri")) +
    annotate("text", x=0,y=0, label="55%", fontface=2, color="grey20", family="Calibri", size=18) 
  bd
})



### query live data from usbr
  asNumeric <- function(x) as.numeric(as.character(x))
  factorsNumeric <- function(d) modifyList(d, lapply(d[, sapply(d, is.factor)],   
                                                   asNumeric))
  
  url <- 'https://www.usbr.gov/lc/region/g4000/hourly/levels.html'

  PREblock <- read_html(url) %>% html_node(".MainContainer .Main-well .dataFrame") %>% html_text() ## pull <pre> tag block from html
  PREblock <- data.frame("line" = unlist(strsplit(PREblock, c("\n")))) ##create data frame, with rows after each new line character (\n)
  url_date <- str_split(PREblock[3,1]," ") ## pull the 3rd line to access date
  url_month <- url_date[[1]][63]
  url_year <- as.numeric(url_date[[1]][64])
  PREblock$flag <- str_detect(PREblock$line, paste0("^",'\\s*', '[0-9]')) ## define rows which contain data 


  data <- PREblock %>% filter(flag=="TRUE") 
  data$table <- c(rep(1, dim(data)[1]/4), rep(2, dim(data)[1]/4), rep(3, dim(data)[1]/4), rep(4,dim(data)[1]/4))

  ### Tables do not have equal spaces between each parameter and there is the possility of blanks being treated as delimiters.   However, fields begin and end at specific character numbers for each table. Use sapply in conjunction with substring to define start and stop characters for each substring/field. 

  #TABLE1 - ACCUMULATIONS
  table1 <- data %>% filter(table==1)
  table1 <- t(sapply(table1$line, substring, c(1,4,12,21,30,37,44,52,59,64,72,79,86,94,100,106,113,123,130,137,146,153,160), c(3,11,19,29,36,43,51,58,63,71,78,85,93,99,105,112,122,129,136,145,152,159,166)))
  colnames(table1) <- c("Date", "Glen Canyon CFS", "Glen Canyon Accum AF", "Lake Mead Elevation Feet", "Hoover Dam CFS", "Hoover Dam Release AF", "Hoover Dam Accum", "Hoover Damnn Gross Gen", "Hoover Dam Rate KWH/AF", "Lake Mohave Elevation Feet", "Davis Dam CFS", "Davis Dam AF", "Davis Dam Release Accum", "Davis Dam Gross Gen", "MWD AF", "MWD Accum", "Lake Havasu Elevation Feet", "Parker Dam CFS", "Parker AF", "Parker Release Release Accum", "Parker Dam Gross Gen", "CAP AF", "CAP Accum") ## hard coding field names
  table1 <- apply(table1,2,function(x)gsub('\\s+', '',x))   ## removing all leading/tailing whitespace
  table1 <- as.data.frame(table1)                           ## setting back to data frame
  table1 <- factorsNumeric(table1)                          ## setting all fields to type numeric (from factor) 


  #TABLE 2 - RESERVOIR ELEVATIONS AND CONTENTS
  table2 <- data %>% filter(table==2)
  table2 <- t(sapply(table2$line, substring, c(1,9,20,29,40,51,63,72,83,92,102,113,122,134,143,152),c(8,19,28,39,50,62,71,82,91,101,112,121,133,142,151,160)))
  colnames(table2) <- c("Date", "Total System Storage", "Total Available Space", "Lake Mead Elevation Feet", "Hoover Content 1000 AF", "Lake Mead Release CFS", "Lake Mohave Elevation Feet", "Davis Content 1000 AF", "Lake Mohave Release CFS", "Lake Havasu Elevation Feet", "Parker Content 1000 AF", "Lake Havasu Release CFS", "Senator Wash Elevation Feet", "Senator Content AF", "Wash Pumped CFS", "Senator Wash Release CFS")
  table2 <- apply(table2,2,function(x)gsub('\\s+', '',x))   ## removing all leading/tailing whitespace
  table2 <- as.data.frame(table2)                           ## setting back to data frame
  table2 <- factorsNumeric(table2)                          ## setting all fields to type numeric (from factor) 


  #TABLE 3 - STORAGE PROJECT DATA
  table3 <- data %>% filter(table==3)
  table3 <- t(sapply(table3$line, substring, c(1,5,12,22,30,39,52,59,68,81,88,97,109,118,126,138,147),c(4,11,21,29,38,51,58,67,80,87,96,108,117,125,137,146,154)))
  colnames(table3) <- c("Date", "Computed Inflow CFS", "Lake Powell Elevation Feet", "Lake Powell Content 1000 AF", "Lake Powell Release CFS", "Flaming Gorge Elevation Feet", "Flaming Gorge Content 1000 AF", "Flaming Gorge Release CFS", "Navajo Elevation Feet", "Navajo Content 1000 AF", "Navajo Release CFS", "Blue Mesa Elevation Feet", "Blue Mesa Content 1000 AF", "Blue Mesa Release CFS", "Morrow Point Elevation Feet", "Morrow Point Content 1000 AF", "Morrow Point Release CFS")
  table3 <- apply(table3,2,function(x)gsub('\\s+', '',x))   ## removing all leading/tailing whitespace
  table3 <- as.data.frame(table3)                           ## setting back to data frame
  table3 <- factorsNumeric(table3)                          ## setting all fields to type numeric (from factor) 


  #TABLE 4 - GLEN CANYON TO HOOVER DAM LOSSES
  table4 <- data %>% filter(table==4)
  table4 <- t(sapply(table4$line, substring, c(1,8,21,33,43,53,63,73,83,93,103),c(7,20,32,42,52,62,72,82,92,102,112)))

  colnames(table4) <- c("Date", 
  "Glen Release CFS", 
  "Hoover Release CFS", 
  "Lake Mead Storage 1000 AF",
  "Storage Change 1000 AF",
  "Lake Mead Pumping CFS",
  "Lake Mead Evaporation CFS",
  "Change Bank Storage CFS",
  "Loss CFS",
  "Accumulation AF",
  "Inflow CFS")
  
  table4 <- apply(table4,2,function(x)gsub('\\s+', '',x))   ## removing all leading/tailing whitespace
  table4 <- as.data.frame(table4)                           ## setting back to data frame
  table4 <- factorsNumeric(table4)                          ## setting all fields to type numeric (from factor) 



output$DateOfData <- renderUI({
  HTML(paste("<br><br>Status as of:", "<br>", url_month," ",max(table1$Date), ", ", url_year, sep=""))
  
})


output$donuts <- renderPlot({


  ### create data for donut plot:

  caps <- data.frame("reservoir"=c("Lake.Powell", "Lake.Mead", "Lake.Mohave", "Lake.Havasu"), "lakesize" = c(24322000/1000, 26120000/1000, 1809800/1000, 619400/1000))


data.donut <- data.frame("Day" = table1$`Date`,"Month"=url_month, "Year"=url_year, "Lake.Powell" = table3$`Lake Powell Content 1000 AF`, "Lake.Mead" = table2$`Hoover Content 1000 AF`, "Lake.Mohave" = table2$`Davis Content 1000 AF`, "Lake.Havasu" = table2$`Parker Content 1000 AF`) %>%
  gather("reservoir", "full", 4:7) %>%
  left_join(caps, by="reservoir") %>%
  mutate("lab" = paste0(round(full/lakesize*100,0),"%"), "ymin" = 0, "xmin" = 70, "xmax" = 100) %>%
  mutate("reservoirLabel" = gsub("\\.", " ", reservoir)) %>%
  mutate("Date" = parse_date_time(paste(Day, Month, Year, sep=" "), orders="dmy")) %>%
  filter(Date == max(Date))

  donut <- ggplot(data.donut) + 
    geom_rect(aes(ymax=100, ymin=0, xmax=100, xmin=70), colour=NA, fill="grey90") +
    geom_rect(aes(fill=full/lakesize*100, ymax=full/lakesize*100, ymin=ymin, xmax=xmax, xmin=xmin)) +
    geom_text(aes(x=0,y=0, label=lab), fontface=2, color="grey20", family="Calibri", size=14)+
    scale_fill_gradient2(low="#FF8c00", midpoint=50, mid="#FFfa00", high="#00ff83", limits=c(0,100), guide=FALSE) +
    coord_polar(theta="y") +
    xlim(c(0,100)) +   
    ylim(c(0,100)) + 
    facet_grid(~reservoirLabel, switch="x") +
    labs(x=NULL, y=NULL) +
    theme_minimal() +
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          axis.text = element_blank(),
          strip.text.x=element_text(size=10, colour="grey60", family="Calibri"), 
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          panel.border= element_blank(),
          plot.margin=unit(c(0,0,0,0),"mm"),
          title = element_blank(), 
          line = element_blank()) 
    
donut

  #ggsave(paste0("C:/Users/bcrary/Desktop/","plotout.jpg"), width=12, height=3)
 
  
})  
})

shinyApp(ui = ui1, server = server1) 

```


## Water Use Network
The graphic below is depiction of the Lower Colorado River Basin and it's water users. The Colorado River is drawn to scale, and major reservoirs are symbolized as nodes along the flow path. Users are linked to a reservoir or pumping station with light gray lines. Users are visualized by bubbles which are scaled based on the end of month use. Use the slider to view usage patterns in previous months. Click on a node to pull up additional information in the pane to the right. 



``` {r echo = FALSE, warning=FALSE, results="asis"}
  
cat("

<style>
  .shiny-frame {
  height: 1000px;
  width: 775px;
  overflow-x: hidden;
  }
</style>

")


rm(list=ls())
library(shiny)
monthStart <- function(x) {
  x <- as.POSIXlt(x)
  x$mday <- 1
  as.Date(x)
}


uframe <- read_csv("Users.csv", col_types=cols())
uframe$MoYear <- as.POSIXct(paste(uframe$Month, "-", 1, "-", uframe$Year, sep=""), format="%m-%d-%Y")


ui <- fluidPage(
  
  fluidRow(
    shiny::column(6, selectInput("scaleby","Scale Users by:",c("End of Month Use", "End of Year Forecast", "Approved Annual Diversion", "Forecasted Annual Excess"))
    ),
    shiny::column(6, selectInput("rscaleby", "Scale Resrvoirs by:", c("Maximum Storage", "End of Month Storage", "Percent Storage Change from Prior Year"))
    )
  ),
  fluidRow(
    column(6, div(plotlyOutput("NetworkPlot", width="370px", height="500px"))
    ), 
    column(6,
      fluidRow(
        mainPanel(width=6, div(style="height:500px;",
          tabsetPanel(type="pills",
            tabPanel("Map", div(leafletOutput("SidePlot", width="370px"), style = "height: 400px; background-color: #fcfcfc; align: left")
              ),
            tabPanel("Details",
              div(tableOutput("shape"))
            )
          ))
        )
      )
    )
  ),  
    fluidRow(shiny::column(12, align="center", sliderInput("slider", "", min = min(uframe$MoYear),max =max(uframe$MoYear),value=max(uframe$MoYear),timeFormat="%b %Y", animate = TRUE)
    )
  )
)


server <- shinyServer(function(input, output, session){
  
  uframe <- read_csv("Users.csv") %>% gather("factor", "value", 11:14)
  nframe <- read_csv("Nodes.csv") %>% gather("factor", "value", 4:7)
  riv <- read_csv("River.csv")
  cons <- read_csv("connections.csv") 
  uframe$MoYear <- as.POSIXct(paste(uframe$Month, "-", 1, "-", uframe$Year, sep=""), format="%m-%d-%Y")
  nframe$MoYear <- as.POSIXct(paste(nframe$Month, "-", 1, "-", nframe$Year, sep=""), format="%m-%d-%Y")
  
  
  ##Link inputs to field names
  
  inputscale <- c("End of Month Use", "End of Year Forecast", "Approved Annual Diversion", "Forecasted Annual Excess", "Maximum Storage", "End of Month Storage", "Percent Storage Change from Prior Year")
  field <- c("endOfMonUse", "eoyForecast", "approvedAnnualVol", "forecastedExcess", "MaxStorage", "LiveStoragePerc", "PriorYearStorageChange")
  scaletab <- data.frame(inputscale, field)

  
  ##Set the slider result to first of month
  sliderMonth <- reactiveValues()
  observe({
    full.date <- as.POSIXct(input$slider, tz="GMT")
    sliderMonth$Month <- as.character(monthStart(full.date))
  })
  output$SliderText <- renderText({sliderMonth$Month})
  
  
  ## Create reactive data frames
  puframe <- reactive({
    df <- uframe %>% 
      filter(MoYear == sliderMonth$Month & factor==scaletab[inputscale==input$scaleby,2])
  })
  
  pnframe <- reactive({
    df <- nframe %>% 
      filter(MoYear == sliderMonth$Month & factor==scaletab[inputscale==input$rscaleby,2]) 
  })
  

  
  output$NetworkPlot <- renderPlotly({

      gg <- ggplot(puframe(), aes(dx, dy)) + 
      geom_point(data=puframe(), aes(size=value, text=sprintf(User), ids=User), colour="slategray", alpha=0.5) +
      geom_path(data=riv, aes(Longitude, Latitude), colour="steelblue", alpha=0.8, size=1) +
      geom_segment(data=cons, aes(x=dx, y=dy, xend=Diversionx, yend=Diversiony), color="steelblue", size=0.5, alpha=0.2) +
      geom_point(data=pnframe(), aes(dx,dy, size=value, colour=value, text=sprintf("Reservoir: %s",Reservoir))) +
      scale_colour_gradient2(low="#FF8c00", midpoint=50, mid="#FFfa00", high="#00ff83",guide=FALSE) +
      coord_equal() +
      xlab("") + 
      ylab("") + 
      xlim(520000,2100000) +
      theme_minimal() +
      theme(panel.background=element_rect(colour=NULL, fill="white"), 
            panel.grid.major=element_blank(), 
            panel.grid.minor=element_blank(), 
            axis.text=element_blank())
      
    gg <- ggplotly(gg, tooltip=c("text")) %>% config(displayModeBar = F) 
    
   })
  
  
  output$SidePlot <- renderLeaflet({
    
    
    ##get subset based on selection
    event.data <- event_data("plotly_click")
    
    if(is.null(event.data)== F) {
      selecteduser <- uframe %>% filter(dx == event.data$x & dy == event.data$y)
      selectedres <-  nframe %>% filter(dx==event.data$x & dy == event.data$y)
    }
    selecteditem <- as.character(
      if(is.null(event.data)==T) {
        "Lower Colorado River Basin"
      } else if(dim(selecteduser)[1]!=0) {
        selecteduser[1,1]
      } else if(dim(selectedres)[1]!=0) {
        selectedres[1,1]
      } else {
        "Lower Colorado River Basin"
      }
    )
    
    UserDA <- st_read("UserDAs.shp", quiet=TRUE) %>% st_transform(4326)
    UserDAplot <- UserDA %>% filter(WaterUser==selecteditem)
    pal <- colorFactor(c("#b2df8a", "steelblue", "firebrick3"), UserDAplot$Type)

    
    m <- leaflet() %>%
      addProviderTiles("CartoDB.Positron", group= "Light Basemap") %>%
      addPolygons(data=UserDAplot,
                  fillOpacity=0.3, 
                  smoothFactor=0.5, 
                  color= ~pal(Type), 
                  label=UserDAplot$WaterUser,
                  labelOptions = labelOptions(noHide = T, direction="top"))
      
  })
  
    
  output$shape <- renderTable({
    
    
    ##get subset based on selection
    event.data <- event_data("plotly_click")

    if(is.null(event.data)== F) {
      selecteduser <- uframe %>% filter(dx == event.data$x & dy == event.data$y)
      selectedres <-  nframe %>% filter(dx==event.data$x & dy == event.data$y)
    }
    selecteditem <- as.character(
      if(is.null(event.data)==T) {
        "Lower Colorado River Basin"
      } else if(dim(selecteduser)[1]!=0) {
        selecteduser[1,1]
      } else if(dim(selectedres)[1]!=0) {
        selectedres[1,1]
      } else {
        "Lower Colorado River Basin"
      }
    )
    selecteditem

  })

})



shinyApp(ui = ui, server = server)





  #uframe$scale <- reactive({ uframe$scale <- if(input$scaleby == "End of Month Use") {
  #  uframe$endOfMonUse
  #} else if(input$scaleby == "End of Year Forecast") {
  #  uframe$eoyForecast 
  #} else if (input$scaleby == "Approved Annual Diversion") {
  #  uframe$approvedAnnualVol
  #} else if (input$scaleby == "Forecasted Annual Excess") {
  #  uframe$forecastedExcess
  #}
  #})



``` 










