---
output: 
  html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_float: true
runtime: shiny
resource_files:
- UserDAs.cpg
- UserDAs.dbf
- UserDAs.prj
- UserDAs.sbn
- UserDAs.sbx
- UserDAs.shp
- UserDAs.shp.xml
- UserDAs.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


# Lower Colorado River Basin
This page is designed to provide current and historic system and water use stats. Data is pulled from.... 


##Current Reservoir Status  

```{r global_options, include=FALSE, resutls='asis'}
library(shiny)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(plotly)
library(leaflet)
library(rgdal)
library(rgeos)
library(sf)
library(raster)

```




``` {r echo = FALSE, warning=FALSE, results='asis'}


library(shiny)
ui1 <- fluidPage(
  fluidRow(
    column(width=12,
      plotOutput("bigdonut"), align ="center"
    )
  ), 
  fluidRow(
    column(width=12,
      plotOutput("donuts"), align="center"
    )
  )
)  


server1 <- shinyServer(function(input, output, session){
  
reservoir <- c("Lake Powell", "Lake Mead", "Lake Mohave", "Lake Havasu")
full <- c(30,50,90,95)
lab <- c("30%", "50%", "90%", "95%")
lakesize <- c(100, 1000, 100, 700)
ymin <- c(0,0,0,0)
xmin <- c(70, 70, 70, 70)
xmax <- c(100, 100, 100, 100)
dat <- tibble(reservoir, lab, full, lakesize, ymin, xmax)

output$bigdonut <- renderPlot({
  tot <- data.frame("reservoir"= "Total System", "full"=55, "lab"="55%", "lakesize"=10000,"ymin"=0,"xmin"=70, "xmax"=100)
  bd <- ggplot(tot) + 
    geom_rect(aes(ymax=100, ymin=0, xmax=100, xmin=70), colour=NA, fill="grey90") +
    geom_rect(aes(fill=full, ymax=full, ymin=ymin, xmax=xmax, xmin=xmin)) +
    scale_fill_gradient2(low="#FF8c00", midpoint=50, mid="#FFfa00", high="#00ff83", limits=c(0,100), guide=FALSE) +
    coord_polar(theta="y") +
    xlim(c(0,100)) + 
    ylim(c(0,100)) + 
    theme_minimal() +
    xlab("") + 
    ylab("Total System") +
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          axis.text=element_blank(), 
          axis.title = element_text(size=13, colour="grey60", family="Calibri")) +
    annotate("text", x=0,y=0, label="55%", fontface=2, color="grey20", family="Calibri", size=18) 
  bd
})


output$donuts <- renderPlot({
  donut <- ggplot(dat) + 
    geom_rect(aes(ymax=100, ymin=0, xmax=100, xmin=70), colour=NA, fill="grey90") +
    geom_rect(aes(fill=full, ymax=full, ymin=ymin, xmax=xmax, xmin=xmin)) +
    geom_text(aes(x=0,y=0, label=lab), fontface=2, color="grey20", family="Calibri", size=14)+
    scale_fill_gradient2(low="#FF8c00", midpoint=50, mid="#FFfa00", high="#00ff83", limits=c(0,100), guide=FALSE) +
    coord_polar(theta="y") +
    xlim(c(0,100)) +   
    ylim(c(0,100)) + 
    theme_minimal() +
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          axis.text=element_blank(),
          strip.text.x=element_text(size=10, colour="grey60", family="Calibri")) +
    xlab("") + 
    ylab("") +
    facet_grid(~reservoir, switch="both")
  donut
})  
})

shinyApp(ui = ui1, server = server1) 

```


## Water Use Network
The graphic below is depiction of the Lower Colorado River Basin and it's water users. The Colorado River is drawn to scale, and major reservoirs are symbolized as nodes along the flow path. Users are linked to a reservoir or pumping station with light gray lines. Users are visualized by bubbles which are scaled based on the end of month use. Use the slider to view usage patterns in previous months. Click on a node to pull up additional information in the pane to the right. 



``` {r echo = FALSE, warning=FALSE, results="asis"}
  
cat("

<style>
  .shiny-frame {
  height: 800px;
  width: 775px;
  overflow-x: hidden;
  }
</style>

")


rm(list=ls())
library(shiny)
monthStart <- function(x) {
  x <- as.POSIXlt(x)
  x$mday <- 1
  as.Date(x)
}


uframe <- read_csv("Users.csv", col_types=cols())
uframe$MoYear <- as.POSIXct(paste(uframe$Month, "-", 1, "-", uframe$Year, sep=""), format="%m-%d-%Y")


ui <- fluidPage(
  
  fluidRow(
    shiny::column(6, selectInput("scaleby","Scale Users by:",c("End of Month Use", "End of Year Forecast", "Approved Annual Diversion", "Forecasted Annual Excess"))
    ),
    shiny::column(6, selectInput("rscaleby", "Scale Resrvoirs by:", c("Maximum Storage", "End of Month Storage", "Percent Storage Change from Prior Year"))
    )
  ),
  fluidRow(
    column(6, div(plotlyOutput("NetworkPlot", width="370px", height="500px"))
    ), 
    column(6,
      fluidRow(
        mainPanel(width=6, div(style="height:500px;",
          tabsetPanel(type="pills",
            tabPanel("Map", div(leafletOutput("SidePlot", width="370px"), style = "height: 400px; background-color: #fcfcfc; align: left")
              ),
            tabPanel("Details",
              div(tableOutput("shape"))
            )
          ))
        )
      )
    )
  ),  
    fluidRow(shiny::column(12, align="center", sliderInput("slider", "Time", min = min(uframe$MoYear),max =max(uframe$MoYear),value=max(uframe$MoYear),timeFormat="%b %Y", animate = TRUE)
    )
  )
)


server <- shinyServer(function(input, output, session){
  
  uframe <- read_csv("Users.csv") %>% gather("factor", "value", 11:14)
  nframe <- read_csv("Nodes.csv") %>% gather("factor", "value", 4:7)
  riv <- read_csv("River.csv")
  cons <- read_csv("connections.csv") 
  uframe$MoYear <- as.POSIXct(paste(uframe$Month, "-", 1, "-", uframe$Year, sep=""), format="%m-%d-%Y")
  nframe$MoYear <- as.POSIXct(paste(nframe$Month, "-", 1, "-", nframe$Year, sep=""), format="%m-%d-%Y")
  
  
  ##Link inputs to field names
  
  inputscale <- c("End of Month Use", "End of Year Forecast", "Approved Annual Diversion", "Forecasted Annual Excess", "Maximum Storage", "End of Month Storage", "Percent Storage Change from Prior Year")
  field <- c("endOfMonUse", "eoyForecast", "approvedAnnualVol", "forecastedExcess", "MaxStorage", "LiveStoragePerc", "PriorYearStorageChange")
  scaletab <- data.frame(inputscale, field)

  
  ##Set the slider result to first of month
  sliderMonth <- reactiveValues()
  observe({
    full.date <- as.POSIXct(input$slider, tz="GMT")
    sliderMonth$Month <- as.character(monthStart(full.date))
  })
  output$SliderText <- renderText({sliderMonth$Month})
  
  
  ## Create reactive data frames
  puframe <- reactive({
    df <- uframe %>% 
      filter(MoYear == sliderMonth$Month & factor==scaletab[inputscale==input$scaleby,2])
  })
  
  pnframe <- reactive({
    df <- nframe %>% 
      filter(MoYear == sliderMonth$Month & factor==scaletab[inputscale==input$rscaleby,2]) 
  })
  

  
  output$NetworkPlot <- renderPlotly({

      gg <- ggplot(puframe(), aes(dx, dy)) + 
      geom_point(data=puframe(), aes(size=value, text=sprintf(User), ids=User), colour="slategray", alpha=0.5) +
      geom_path(data=riv, aes(Longitude, Latitude), colour="steelblue", alpha=0.8, size=1) +
      geom_segment(data=cons, aes(x=dx, y=dy, xend=Diversionx, yend=Diversiony), color="steelblue", size=0.5, alpha=0.2) +
      geom_point(data=pnframe(), aes(dx,dy, size=value, colour=value, text=sprintf("Reservoir: %s",Reservoir))) +
      scale_colour_gradient2(low="#FF8c00", midpoint=50, mid="#FFfa00", high="#00ff83",guide=FALSE) +
      coord_equal() +
      xlab("") + 
      ylab("") + 
      xlim(520000,2100000) +
      theme_minimal() +
      theme(panel.background=element_rect(colour=NULL, fill="white"), 
            panel.grid.major=element_blank(), 
            panel.grid.minor=element_blank(), 
            axis.text=element_blank())
      
    gg <- ggplotly(gg, tooltip=c("text")) %>% config(displayModeBar = F) 
    
   })
  
  
  output$SidePlot <- renderLeaflet({
    
    
    ##get subset based on selection
    event.data <- event_data("plotly_click")
    
    if(is.null(event.data)== F) {
      selecteduser <- uframe %>% filter(dx == event.data$x & dy == event.data$y)
      selectedres <-  nframe %>% filter(dx==event.data$x & dy == event.data$y)
    }
    selecteditem <- as.character(
      if(is.null(event.data)==T) {
        "Lower Colorado River Basin"
      } else if(dim(selecteduser)[1]!=0) {
        selecteduser[1,1]
      } else if(dim(selectedres)[1]!=0) {
        selectedres[1,1]
      } else {
        "Lower Colorado River Basin"
      }
    )
    
    UserDA <- st_read("UserDAs.shp", quiet=TRUE) %>% st_transform(4326)
    UserDAplot <- UserDA %>% filter(WaterUser==selecteditem)
    pal <- colorFactor(c("#b2df8a", "steelblue", "firebrick3"), UserDAplot$Type)

    
    m <- leaflet() %>%
      addProviderTiles("CartoDB.Positron", group= "Light Basemap") %>%
      addPolygons(data=UserDAplot,
                  fillOpacity=0.3, 
                  smoothFactor=0.5, 
                  color= ~pal(Type), 
                  label=UserDAplot$WaterUser,
                  labelOptions = labelOptions(noHide = T, direction="top"))
      
  })
  
    
  output$shape <- renderTable({
    
    
    ##get subset based on selection
    event.data <- event_data("plotly_click")

    if(is.null(event.data)== F) {
      selecteduser <- uframe %>% filter(dx == event.data$x & dy == event.data$y)
      selectedres <-  nframe %>% filter(dx==event.data$x & dy == event.data$y)
    }
    selecteditem <- as.character(
      if(is.null(event.data)==T) {
        "Lower Colorado River Basin"
      } else if(dim(selecteduser)[1]!=0) {
        selecteduser[1,1]
      } else if(dim(selectedres)[1]!=0) {
        selectedres[1,1]
      } else {
        "Lower Colorado River Basin"
      }
    )
    selecteditem

  })

})



shinyApp(ui = ui, server = server)





  #uframe$scale <- reactive({ uframe$scale <- if(input$scaleby == "End of Month Use") {
  #  uframe$endOfMonUse
  #} else if(input$scaleby == "End of Year Forecast") {
  #  uframe$eoyForecast 
  #} else if (input$scaleby == "Approved Annual Diversion") {
  #  uframe$approvedAnnualVol
  #} else if (input$scaleby == "Forecasted Annual Excess") {
  #  uframe$forecastedExcess
  #}
  #})



``` 










